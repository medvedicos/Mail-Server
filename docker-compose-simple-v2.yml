services:
  mailserver:
    image: ghcr.io/docker-mailserver/docker-mailserver:latest
    container_name: mailserver
    hostname: mail.sutulaya.lol
    domainname: sutulaya.lol
    restart: unless-stopped
    env_file: mailserver.env
    ports:
      - "25:25"
      - "143:143"
      - "465:465"
      - "587:587"
      - "993:993"
    volumes:
      - ./data/mail-data/:/var/mail/
      - ./data/mail-state/:/var/mail-state/
      - ./data/mail-logs/:/var/log/mail/
      - ./config/:/tmp/docker-mailserver/
      - ./ssl:/etc/ssl/mail:ro
      - /etc/localtime:/etc/localtime:ro
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: "ss --listening --tcp | grep -P 'LISTEN.+:smtp' || exit 1"
      timeout: 3s
      retries: 0

  mysql:
    image: mysql:8.0
    container_name: mailserver-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-roundcube}
      MYSQL_USER: ${MYSQL_USER:-roundcube}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./data/mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  roundcube:
    image: roundcube/roundcubemail:latest
    container_name: mailserver-webmail
    restart: unless-stopped
    environment:
      ROUNDCUBEMAIL_DEFAULT_HOST: ssl://mailserver
      ROUNDCUBEMAIL_SMTP_SERVER: tls://mailserver
      ROUNDCUBEMAIL_DB_TYPE: mysql
      ROUNDCUBEMAIL_DB_HOST: mysql
      ROUNDCUBEMAIL_DB_PORT: 3306
      ROUNDCUBEMAIL_DB_USER: ${MYSQL_USER:-roundcube}
      ROUNDCUBEMAIL_DB_PASSWORD: ${MYSQL_PASSWORD}
      ROUNDCUBEMAIL_DB_NAME: ${MYSQL_DATABASE:-roundcube}
      ROUNDCUBEMAIL_DEFAULT_PORT: 993
      ROUNDCUBEMAIL_SMTP_PORT: 587
      ROUNDCUBEMAIL_LANGUAGE: ru_RU
      ROUNDCUBEMAIL_PLUGINS: archive,zipdownload,managesieve
      ROUNDCUBEMAIL_UPLOAD_MAX_FILESIZE: 50M
    expose:
      - "80"
    volumes:
      - ./data/roundcube:/var/www/html
      - ./config/roundcube/custom-ssl.inc.php:/var/roundcube/config/custom.inc.php:ro
    depends_on:
      mysql:
        condition: service_healthy
      mailserver:
        condition: service_started

  nginx:
    image: nginx:alpine
    container_name: mailserver-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./data/certbot/www:/var/www/certbot:ro
    depends_on:
      - roundcube
      - registration
      - login

  registration:
    build:
      context: ./registration
      dockerfile: Dockerfile
    container_name: mailserver-registration
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    expose:
      - "8080"
    user: root
    depends_on:
      mailserver:
        condition: service_started

  login:
    build:
      context: ./login
      dockerfile: Dockerfile
    container_name: mailserver-login
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      - roundcube
