version: '3.8'

services:
  # PostgreSQL Database for user management
  postgres:
    image: postgres:15-alpine
    container_name: mailserver-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./config/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - mailserver-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: mailserver-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - ./data/redis:/data
    networks:
      - mailserver-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Postfix - SMTP Server
  postfix:
    image: boky/postfix:latest
    container_name: mailserver-postfix
    restart: unless-stopped
    hostname: ${POSTFIX_HOSTNAME}
    environment:
      ALLOW_EMPTY_SENDER_DOMAINS: "true"
      ALLOWED_SENDER_DOMAINS: ${POSTFIX_DOMAIN}
      POSTFIX_myhostname: ${POSTFIX_HOSTNAME}
      POSTFIX_mydomain: ${POSTFIX_DOMAIN}
      POSTFIX_myorigin: ${POSTFIX_DOMAIN}
      POSTFIX_message_size_limit: 52428800
    ports:
      - "25:25"     # SMTP
      - "587:587"   # Submission (STARTTLS)
      - "465:465"   # SMTPS (SSL/TLS)
    volumes:
      - ./config/postfix/main.cf:/etc/postfix/main.cf.d/custom.cf:ro
      - ./config/postfix/master.cf:/etc/postfix/master.cf.d/custom.cf:ro
      - ./data/mail:/var/mail
      - ./data/spool:/var/spool/postfix
      - ./ssl:/etc/ssl/mail:ro
      - ./data/dkim:/etc/opendkim
    networks:
      - mailserver-network
    depends_on:
      postgres:
        condition: service_healthy

  # Dovecot - IMAP/POP3 Server
  dovecot:
    image: dovecot/dovecot:latest
    container_name: mailserver-dovecot
    restart: unless-stopped
    hostname: ${HOSTNAME}
    ports:
      - "143:143"   # IMAP
      - "993:993"   # IMAPS
      - "110:110"   # POP3
      - "995:995"   # POP3S
    volumes:
      - ./config/dovecot/dovecot.conf:/etc/dovecot/dovecot.conf:ro
      - ./config/dovecot/conf.d:/etc/dovecot/conf.d:ro
      - ./data/mail:/var/mail
      - ./ssl:/etc/ssl/mail:ro
    networks:
      - mailserver-network
    depends_on:
      postgres:
        condition: service_healthy

  # Roundcube - Webmail Interface
  roundcube:
    image: roundcube/roundcubemail:latest
    container_name: mailserver-webmail
    restart: unless-stopped
    environment:
      ROUNDCUBEMAIL_DB_TYPE: pgsql
      ROUNDCUBEMAIL_DB_HOST: postgres
      ROUNDCUBEMAIL_DB_NAME: ${POSTGRES_DB}
      ROUNDCUBEMAIL_DB_USER: ${POSTGRES_USER}
      ROUNDCUBEMAIL_DB_PASSWORD: ${POSTGRES_PASSWORD}
      ROUNDCUBEMAIL_DEFAULT_HOST: ssl://dovecot
      ROUNDCUBEMAIL_DEFAULT_PORT: 993
      ROUNDCUBEMAIL_SMTP_SERVER: tls://postfix
      ROUNDCUBEMAIL_SMTP_PORT: 587
      ROUNDCUBEMAIL_UPLOAD_MAX_FILESIZE: 50M
      ROUNDCUBEMAIL_SKIN: elastic
    ports:
      - "${WEBMAIL_PORT}:80"
    volumes:
      - ./data/roundcube:/var/www/html
      - ./config/roundcube/config.inc.php:/var/www/html/config/config.inc.php:ro
    networks:
      - mailserver-network
    depends_on:
      postgres:
        condition: service_healthy
      dovecot:
        condition: service_started
      postfix:
        condition: service_started

  # SpamAssassin - Spam Filter
  spamassassin:
    image: instantlinux/spamassassin:latest
    container_name: mailserver-spamassassin
    restart: unless-stopped
    environment:
      TZ: ${TZ}
    volumes:
      - ./data/spamassassin:/var/lib/spamassassin
    networks:
      - mailserver-network
    profiles:
      - security

networks:
  mailserver-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  mail-data:
  roundcube-data:
